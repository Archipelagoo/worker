async function submitAttendance() {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;

    const now = new Date();
    const tanggal = formatTanggalIndo(now);
    const jam = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });

    const attendance = workers.map(w => ({
        name: w.name,
        status: attendanceStatus[w.id] || '-'
    }));

    // --- STRATEGI 1: SIAPKAN FILE SECARA INSTAN ---
    // Jangan lakukan fetch di sini agar memori tetap segar untuk Share Sheet
    let filesForShare = [];
    if (isIOS() && uploadedPhotos.length > 0) {
        // Gunakan Promise.all agar konversi Blob sangat cepat
        filesForShare = await Promise.all(uploadedPhotos.map(async (base64, i) => {
            const res = await fetch(base64);
            const blob = await res.blob();
            return new File([blob], `Absen_${tanggal}_${jam.replace(/:/g, '-')}_${i+1}.jpg`, { type: "image/jpeg" });
        }));
    }

    // --- STRATEGI 2: PANGGIL SHARE SHEET DULUAN (KUNCI UTAMA) ---
    // Kita panggil Share Sheet SEBELUM melakukan fetch ke server.
    // Ini menjamin "User Gesture" masih 100% valid dan tidak akan diblokir.
    if (isIOS() && filesForShare.length > 0) {
        try {
            // Share sheet akan muncul seketika saat user klik tombol
            await navigator.share({
                files: filesForShare,
                title: 'Simpan Foto Absensi',
                text: `Data Absen ${tanggal} ${jam}`
            });
        } catch (shareErr) {
            console.log("Share dibatalkan atau gagal");
        }
    }

    // --- STRATEGI 3: PROSES PENGIRIMAN DATA DI BELAKANG LAYAR ---
    showUploadProgress();
    updateUploadProgress('Mengirim data...', 'Ke Spreadsheet & Drive', 30);

    try {
        // Kirim data absen
        const attendanceResponse = await fetch(scriptUrl, { 
            method: 'POST', 
            body: new URLSearchParams({ 
                data: JSON.stringify({ action: 'submitAttendance', tanggal, jam, attendance }) 
            }),
            redirect: 'follow' 
        });

        // Kirim foto ke Drive (tidak perlu ditunggu/await agar lebih cepat selesai di mata user)
        if (uploadedPhotosCompressed.length > 0) {
            fetch(scriptUrl, { 
                method: 'POST', 
                body: new URLSearchParams({ 
                    data: JSON.stringify({ action: 'uploadPhotos', tanggal, jam, photos: uploadedPhotosCompressed }) 
                }),
                redirect: 'follow' 
            });
        }

        updateUploadProgress('Selesai!', 'Absensi berhasil dikirim', 100);
        setTimeout(hideUploadProgress, 1000);
        showNotification('Absen berhasil dikirim!');
        
        // Reset Aplikasi
        attendanceStatus = {};
        uploadedPhotos = [];
        uploadedPhotosCompressed = [];
        renderPhotoThumbnails();
        renderWorkers(workers);
        updateCounter();

    } catch (error) {
        hideUploadProgress();
        showNotification('Data gagal terkirim ke server!', true);
    } finally {
        btn.disabled = false;
    }
}
